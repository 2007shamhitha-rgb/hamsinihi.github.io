<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Timetable AI - VCEW Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --morning-break: #fef3c7;
            --lunch-break: #fee2e2;
            --evening-break: #e0e7ff;
        }

        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            color: var(--text-main); min-height: 100vh; padding: 20px; transition: background 0.5s ease;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container { 
            max-width: 1200px; margin: 20px auto; background: var(--card-bg); 
            padding: 30px; border-radius: 24px; box-shadow: var(--shadow);
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3);
            animation: fadeIn 0.6s ease-out;
        }

        .logo-container { text-align: center; margin-bottom: 25px; }
        .logo-container img { max-width: 400px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .college-title { font-weight: 800; color: #4b2c85; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }

        .hidden { display: none; }
        button { 
            padding: 12px 20px; border: none; border-radius: 10px; 
            background: var(--primary); color: white; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; display: inline-flex;
            align-items: center; justify-content: center; gap: 8px; font-size: 14px;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-2px); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        
        .logout { background: #64748b; }
        .clear { background: var(--danger); }
        .pdf-btn { background: #ef4444; }
        .share { background: #25d366; }
        .dark-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; background: #1e293b; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; background: white; }
        th, td { padding: 10px; text-align: center; font-size: 11px; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; position: relative; }
        th { background: #f8fafc; color: #475569; font-weight: 700; text-transform: uppercase; }

        .break-morning { background: var(--morning-break) !important; color: #92400e; font-weight: 800; }
        .break-lunch { background: var(--lunch-break) !important; color: #991b1b; font-weight: 800; }
        .break-evening { background: var(--evening-break) !important; color: #3730a3; font-weight: 800; }
        .theory { background: #f0f9ff; border-left: 3px solid #0ea5e9; }
        .lab { background: #f0fdf4; border-left: 3px solid #22c55e; }
        .contTheory { background: #e0f2fe; font-weight: 600; border-left: 3px solid #0ea5e9; }
        .contLab { background: #dcfce7; font-weight: 600; border-left: 3px solid #22c55e; }
        .free { background: #ffffff; color: #cbd5e1; font-style: italic; }

        .admin-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-box { margin-top: 25px; padding: 20px; background: rgba(248, 250, 252, 0.8); border-radius: 20px; border: 1px solid #e2e8f0; }

        input, select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-family: inherit; }
        body.dark-mode { background: #0f172a; }
        body.dark-mode .container { background: #1e293b; color: white; border-color: #334155; }
        body.dark-mode .card, body.dark-mode table, body.dark-mode input, body.dark-mode select { background: #334155; color: white; border-color: #475569; }

        /* Specific styles for the PDF Export Area */
        #export-area { position: absolute; left: -9999px; top: 0; background: white; width: 1000px; padding: 20px; color: black; }
        #export-area .card { box-shadow: none; border: 1px solid #eee; break-inside: avoid; margin-bottom: 20px; }
        #export-area table { border: 1px solid #000; border-collapse: collapse; width: 100%; }
        #export-area th, #export-area td { border: 1px solid #000; color: black !important; }

        #pdf-header { display: none; text-align: center; margin-bottom: 20px; }
        #pdf-header img { width: 350px; }
        .finalize-msg { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 10px; font-weight: 700; text-align: center; margin-bottom: 15px; border: 2px solid #ef4444; }
    </style>
</head>
<body>

<button class="dark-toggle" onclick="document.body.classList.toggle('dark-mode')">üåì Mode</button>

<div class="container" id="loginPage">
    <div class="logo-container">
        <img src="https://vcew.ac.in/wp-content/uploads/2021/05/vcew_logo.png" alt="VCEW Logo">
        <div class="college-title">VIVEKANANDHA COLLEGE OF ENGINEERING FOR WOMEN (Autonomous)</div>
        <p style="color:var(--text-muted)">Smart Automatic Timetable Infrastructure</p>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
        <button onclick="attemptAdminLogin()">üîë Admin Dashboard</button>
        <button onclick="attemptStaffLogin()">üë®‚Äçüè´ Staff Access</button>
        <button onclick="openPanel('student')">üéì Student Portal</button>
    </div>
</div>

<div class="container hidden" id="mainPage">
    <div id="adminLogoHeader" class="logo-container">
        <img src="https://vcew.ac.in/wp-content/uploads/2021/05/vcew_logo.png" alt="VCEW Logo">
        <div class="college-title">VIVEKANANDHA COLLEGE OF ENGINEERING FOR WOMEN (Autonomous)</div>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <h3 id="panelTitle" style="margin:0;">Panel</h3>
            <span id="roleBadge" style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #e2e8f0;"></span>
        </div>
        <button class="logout" onclick="location.reload()">üö™ Exit</button>
    </div>

    <div id="finalize-banner" class="finalize-msg hidden">Timetable Finalized. No More Entries Allowed.</div>

    <div id="admin" class="section-box hidden">
        <div class="admin-grid">
            <div class="card">
                <h4>1. Logic Config</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <div><label>Periods</label><input id="periodCount" type="number" value="10"></div>
                    <div><label>Morn Brk</label><input id="break1" type="number" value="3"></div>
                    <div><label>Lunch</label><input id="lunch" type="number" value="5"></div>
                    <div><label>Eve Brk</label><input id="evening" type="number" value="8"></div>
                    <div><label>Theory Blk</label><input id="theoryCount" type="number" value="1"></div>
                    <div><label>Lab Blk</label><input id="labCount" type="number" value="3"></div>
                </div>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <h4>2. Add Faculty</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                    <select id="dept"><option>CSE</option><option>IT</option><option>ECE</option><option>EEE</option><option>BT</option><option>BME</option></select>
                    <select id="year"><option>1</option><option>2</option><option>3</option><option>4</option></select>
                    <select id="section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:8px; margin-top:8px;">
                    <input id="staffId" placeholder="Staff ID" class="fac-input">
                    <input id="staffName" placeholder="Staff Name" class="fac-input">
                </div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:8px; margin-top:8px;">
                    <input id="subject" placeholder="Subject Name" class="fac-input">
                    <input id="hallNo" placeholder="Hall No" class="fac-input">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;">
                    <select id="isLab" class="fac-input"><option value="no">Theory</option><option value="yes">Lab</option></select>
                    <input id="workload" type="number" value="5" placeholder="Workload (hrs)" class="fac-input">
                </div>
                <button id="addEntryBtn" onclick="saveFaculty()" style="width:100%; margin-top:10px; background: #1e293b;">üíæ Add Entry</button>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button id="genBtn" style="flex:1" onclick="generate()">‚ö° Full Generate</button>
                    <button id="flushBtn" style="flex:1; background: var(--warning);" onclick="flushRegenerate()">üîÑ Flush & Regenerate</button>
                </div>
                <button id="wipeAllBtn" class="clear" style="width:100%; margin-top:8px;" onclick="clearAll()">üóëÔ∏è Wipe Data</button>
                <button class="pdf-btn" style="width:100%; margin-top:8px;" onclick="exportToPDF()">üì• Export All to PDF</button>
            </div>

            <div class="card">
                <div style="background: #fff7ed; padding: 12px; border-radius: 10px; border: 1px solid #ffedd5;">
                    <h4 style="margin-top:0">üîí Manual Fix</h4>
                    <select id="fixDay"><option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option><option value="3">Thu</option><option value="4">Fri</option></select>
                    <input id="fixPeriod" type="number" placeholder="Period (1-10)" style="margin-top:5px;">
                    <input id="fixStaffId" type="text" placeholder="Staff ID" style="margin-top:5px;">
                    <button id="manualFixBtn" class="fix" onclick="uiSetFixed()" style="width:100%; margin-top:8px; background:var(--success)">Lock Slot</button>
                    <button id="manualClearBtn" class="clear" onclick="uiClearFixed()" style="width:100%; margin-top:4px; background: #94a3b8;">Unlock Sec</button>
                    <p id="fixedMsg" style="font-size:10px; text-align:center; font-weight:bold; margin-top:4px;"></p>
                </div>
                <div style="background: #f0f9ff; padding: 12px; border-radius: 10px; border: 1px solid #e0f2fe; margin-top: 15px;">
                    <h4 style="margin-top:0">‚ôªÔ∏è Replace Faculty</h4>
                    <select id="repSec"><option>A</option><option>B</option><option>C</option><option>D</option></select>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                        <select id="repDay"><option value="0">Mon</option><option value="1">Tue</option><option value="2">Wed</option><option value="3">Thu</option><option value="4">Fri</option></select>
                        <input id="repPeriod" type="number" placeholder="P (1-10)">
                    </div>
                    <input id="repStaffId" type="text" placeholder="New Staff ID" style="margin-top:5px;">
                    <button id="replaceBtn" onclick="replaceFaculty()" style="width:100%; margin-top:8px; background:var(--primary)">Replace</button>
                </div>
                <div class="section-box" style="margin-top:15px; font-size: 12px;">
                    <h4>üìä Health</h4>
                    <div id="healthReport">Ready.</div>
                </div>
            </div>
        </div>
        <div id="allTimetables"></div>
    </div>

    <div id="staff" class="section-box hidden">
        <div class="card">
            <h4>üë®‚Äçüè´ Staff Schedule</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input id="sId" placeholder="Enter Staff ID">
                <button onclick="staffView()">View</button>
            </div>
            <div id="staffWorkload" style="text-align:center; font-weight:bold; color:var(--primary); margin-top:10px;"></div>
        </div>
    </div>

    <div id="student" class="section-box hidden">
        <div class="card">
            <h4>üéì Class Portal</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
                <select id="stDept"><option>CSE</option><option>IT</option><option>ECE</option><option>EEE</option><option>BT</option><option>BME</option></select>
                <select id="stYear"><option>1</option><option>2</option><option>3</option><option>4</option></select>
                <select id="stSection"><option>A</option><option>B</option><option>C</option><option>D</option></select>
                <button onclick="studentView()">Fetch</button>
            </div>
        </div>
    </div>

    <div id="export-area">
        <div id="pdf-header">
            <img src="https://vcew.ac.in/wp-content/uploads/2021/05/vcew_logo.png" alt="Logo">
            <h2 style="margin:5px 0; color:#4b2c85;">VIVEKANANDHA COLLEGE OF ENGINEERING FOR WOMEN (Autonomous)</h2>
            <h4 id="pdf-meta" style="color:#64748b; margin-bottom: 15px;"></h4>
        </div>
        <div id="export-content"></div>
    </div>
    
    <div id="output" style="margin-top: 20px;"></div>

    <div id="pdf-btn-container" class="hidden" style="padding: 20px 0; display:flex; gap:10px; justify-content:center;">
        <button class="pdf-btn" onclick="exportToPDF()">üì• PDF</button>
        <button class="share" onclick="shareViaWhatsApp()">üì± WhatsApp</button>
        <button onclick="window.print()" style="background:#334155">üñ®Ô∏è Print</button>
    </div>
</div>

<script>
    let faculty = JSON.parse(localStorage.getItem("faculty")||"[]");
    let timetables = JSON.parse(localStorage.getItem("timetables")||"{}");
    let fixedPeriods = JSON.parse(localStorage.getItem("fixedPeriods")||"{}");
    let currentUserRole = "guest";

    function attemptAdminLogin() {
        const pass = prompt("Enter Admin Password:");
        if(pass === "admin123") {
            currentUserRole = "admin";
            openPanel('admin');
        } else {
            alert("Incorrect password.");
        }
    }

    function attemptStaffLogin() {
        const pass = prompt("Enter Staff Password:");
        if(pass === "staff123") {
            currentUserRole = "staff";
            openPanel('staff');
        } else {
            alert("Incorrect password.");
        }
    }

    function checkAdminAuth() {
        if(currentUserRole !== "admin" && currentUserRole !== "staff") {
            alert("You are not authorized to perform this action.");
            return false;
        }
        return true;
    }
    
    function isStrictAdmin() {
        if(currentUserRole !== "admin") {
            alert("You are not authorized to perform this action.");
            return false;
        }
        return true;
    }

    function openPanel(p){
        if(p === 'admin' && currentUserRole !== 'admin') return alert("Unauthorized.");
        if(p === 'staff' && currentUserRole !== 'staff' && currentUserRole !== 'admin') return alert("Unauthorized.");

        loginPage.classList.add("hidden");
        mainPage.classList.remove("hidden");
        admin.classList.add("hidden"); staff.classList.add("hidden"); student.classList.add("hidden");
        document.getElementById(p).classList.remove("hidden");
        document.getElementById('panelTitle').innerText = p.toUpperCase();
        document.getElementById('roleBadge').innerText = currentUserRole.toUpperCase();
        document.getElementById('adminLogoHeader').style.display = 'block';
        document.getElementById('pdf-btn-container').classList.add('hidden');
        document.getElementById('output').innerHTML = "";
        
        checkLockState(); 
        if(p === 'admin') renderAll();
    }

    function isSectionFinalized(key) {
        if(!timetables[key]) return false;
        return timetables[key].isFinalized === true;
    }

    function checkLockState() {
        const key = `${dept.value}-${year.value}-${section.value}`;
        const isLocked = isSectionFinalized(key);
        const banner = document.getElementById('finalize-banner');
        const inputs = document.querySelectorAll('.fac-input');
        
        const controls = [
            'addEntryBtn', 'genBtn', 'flushBtn', 
            'manualFixBtn', 'manualClearBtn', 'replaceBtn'
        ];

        if(isLocked && currentUserRole === 'admin') {
            banner.classList.remove('hidden');
            inputs.forEach(i => i.disabled = true);
            controls.forEach(id => document.getElementById(id).disabled = true);
        } else {
            banner.classList.add('hidden');
            inputs.forEach(i => i.disabled = false);
            controls.forEach(id => document.getElementById(id).disabled = false);
        }
    }

    function saveFaculty(){
        if(!checkAdminAuth()) return;
        const key = `${dept.value}-${year.value}-${section.value}`;
        if(isSectionFinalized(key)) return alert("Class Finalized. Modification locked.");

        if(!staffId.value || !staffName.value || !subject.value || !hallNo.value){alert("Fill all fields!"); return;}
        
        faculty.push({
            staffId: staffId.value.trim(), staff: staffName.value.trim(), subject: subject.value.trim(),
            hall: hallNo.value.trim(), dept: dept.value, year: year.value, section: section.value,
            workload: +workload.value, isLab: isLab.value==="yes",
            theoryC: +theoryCount.value, labC: +labCount.value
        });
        localStorage.setItem("faculty", JSON.stringify(faculty));
        staffId.value = ""; staffName.value = ""; subject.value = ""; hallNo.value = ""; staffId.focus();
        renderAll(); updateHealth();
    }

    function getSlots() {
        let total = +periodCount.value, s = [];
        const mornBrk = +break1.value;
        const lunchBrk = +lunch.value;
        const eveBrk = +evening.value;

        for (let i = 1; i <= total; i++) {
            if (i === mornBrk) s.push("MORNING_BREAK");
            else if (i === lunchBrk) s.push("LUNCH");
            else if (i === eveBrk) s.push("EVENING_BREAK");
            else s.push("P" + (s.filter(x => !x.includes("BREAK") && x !== "LUNCH").length + 1));
        }
        return s;
    }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    function isStaffBusy(sid, d, p, currentKey) {
        for (let k in timetables) {
            if (k === currentKey) continue;
            let targetGrid = timetables[k].grid;
            if (targetGrid && targetGrid[d] && targetGrid[d][p] && targetGrid[d][p].staffId === sid) return true;
        }
        return false;
    }

    function checkContinuousClash(sid, d, p, currentKey) {
        let slots = getSlots();
        let neighbors = [p-1, p+1];
        for (let n of neighbors) {
            if (n < 0 || n >= slots.length) continue;
            if (slots[n].includes("BREAK") || slots[n] === "LUNCH") continue;
            if (isStaffBusy(sid, d, n, currentKey)) return true;
        }
        return false;
    }

    function generate() {
        if(!checkAdminAuth()) return;
        const currentDept = dept.value;
        const currentYear = year.value;
        const currentSec = section.value;
        let key = `${currentDept}-${currentYear}-${currentSec}`;
        
        if(isSectionFinalized(key)) { alert("Finalized! Unfinalize to regenerate."); return; }
        
        let slots = getSlots();
        let secFaculty = faculty.filter(f => f.dept === currentDept && f.year == currentYear && f.section === currentSec);
        if (!secFaculty.length) { alert("Add faculty first!"); return; }

        let success = false, attempts = 200, bestGrid = null;
        while (attempts-- > 0 && !success) {
            let grid = Array.from({length: 5}, () => Array(slots.length).fill(null));
            let rem = {};
            secFaculty.forEach(f => rem[f.staffId] = (rem[f.staffId] || 0) + f.workload);
            
            if (fixedPeriods[key]) {
                for (let coord in fixedPeriods[key]) {
                    let [d, p] = coord.split("-").map(Number);
                    if (p < slots.length) { 
                        grid[d][p] = fixedPeriods[key][coord]; 
                        rem[fixedPeriods[key][coord].staffId]--; 
                    }
                }
            }
            
            let days = shuffle([0, 1, 2, 3, 4]);
            for (let d of days) {
                let labPlaced = false, dailyFaculty = shuffle([...secFaculty]);
                for (let f of dailyFaculty) {
                    if (rem[f.staffId] <= 0) continue;
                    if (f.isLab && labPlaced) continue;
                    let bSize = f.isLab ? f.labC : f.theoryC, toPlace = Math.min(bSize, rem[f.staffId]), validStarts = [];
                    
                    for(let i=0; i <= slots.length - toPlace; i++) {
                        let path = [], tempIdx = i, count = 0, isValidPath = true;
                        while(count < toPlace && tempIdx < slots.length) {
                            if (slots[tempIdx] === "LUNCH") { isValidPath = false; break; }
                            if (slots[tempIdx].includes("BREAK")) { if (f.isLab) { tempIdx++; continue; } else { isValidPath = false; break; } }
                            if (grid[d][tempIdx] || isStaffBusy(f.staffId, d, tempIdx, key)) { isValidPath = false; break; }
                            if (checkContinuousClash(f.staffId, d, tempIdx, key) && toPlace === 1) { isValidPath = false; break; }
                            path.push(tempIdx); count++; tempIdx++;
                        }
                        if (isValidPath && count === toPlace) validStarts.push(path);
                    }
                    if (validStarts.length > 0) {
                        let chosenPath = validStarts[Math.floor(Math.random() * validStarts.length)];
                        chosenPath.forEach(pIdx => { grid[d][pIdx] = { ...f, cont: toPlace > 1 }; });
                        rem[f.staffId] -= toPlace; if (f.isLab) labPlaced = true;
                    }
                }
            }
            let totalLeft = Object.values(rem).reduce((a, b) => a + Math.max(0, b), 0);
            if (totalLeft <= 0) { bestGrid = grid; success = true; }
            else if (!bestGrid || totalLeft < bestGrid.leftover) { bestGrid = grid; bestGrid.leftover = totalLeft; }
        }
        
        timetables[key] = { 
            slots, 
            grid: bestGrid, 
            timestamp: new Date().toLocaleString(),
            isFinalized: false 
        };
        localStorage.setItem("timetables", JSON.stringify(timetables));
        renderAll(); checkLockState();
        if(success) alert("Successful!"); else alert("Filled as much as possible. Try regenerating or check constraints.");
    }

    function toggleFinalize(key) {
        if(!checkAdminAuth()) return;
        const currentState = timetables[key].isFinalized;
        const action = currentState ? "Unfinalize" : "Finalize";
        if(confirm(`${action} ${key}?`)) {
            timetables[key].isFinalized = !currentState;
            localStorage.setItem("timetables", JSON.stringify(timetables));
            renderAll();
            checkLockState();
        }
    }

    function flushRegenerate() {
        if(!isStrictAdmin()) return;
        let key = `${dept.value}-${year.value}-${section.value}`;
        if(isSectionFinalized(key)) return alert("Class Finalized. Modification locked.");
        if(!timetables[key]) return alert("No data.");
        timetables[key].grid = null;
        generate();
    }

    function replaceFaculty() {
        if(!checkAdminAuth()) return;
        let sec = repSec.value, keyFound = "";
        for(let k in timetables) { if(k.endsWith(sec)) { keyFound = k; break; } }
        if(isSectionFinalized(keyFound)) return alert("Finalized Class. Modification locked.");
        
        let d = parseInt(repDay.value), pNum = parseInt(repPeriod.value), sid = repStaffId.value.trim();
        let tt = timetables[keyFound];
        if(!tt) return alert("Not found.");
        
        let pIdx = -1, count = 0;
        for(let i=0; i<tt.slots.length; i++) { if(tt.slots[i].startsWith("P")) { count++; if(count === pNum) { pIdx = i; break; } } }
        
        let newFac = faculty.find(f => f.staffId === sid && f.section === sec);
        if(!newFac || isStaffBusy(sid, d, pIdx, keyFound)) return alert("Invalid or Staff Busy.");
        
        tt.grid[d][pIdx] = { ...newFac, cont: false };
        localStorage.setItem("timetables", JSON.stringify(timetables));
        renderAll();
    }

    function render(slots, grid, onlyId = null, showSec = false) {
        let h = "<table><thead><tr><th>Day</th>"; 
        slots.forEach(s => h += `<th>${s.replace('_', ' ')}</th>`);
        h += "</tr></thead><tbody>";
        ["MON","TUE","WED","THU","FRI"].forEach((day, d) => {
            h += `<tr><td style="font-weight:bold">${day}</td>`;
            grid[d].forEach((c, i) => {
                if(slots[i] === "MORNING_BREAK") h += `<td class='break-morning'>BRK</td>`;
                else if(slots[i] === "LUNCH") h += `<td class='break-lunch'>LUNCH</td>`;
                else if(slots[i] === "EVENING_BREAK") h += `<td class='break-evening'>E-BRK</td>`;
                else if(!c || (onlyId && c.staffId !== onlyId)) h += `<td class='free'>-</td>`;
                else {
                    let cls = c.isLab ? (c.cont ? 'contLab' : 'lab') : (c.cont ? 'contTheory' : 'theory');
                    h += `<td class='${cls}'><b>${c.subject}</b><br><small>${c.staff}</small><br><span style="color:#6366f1;font-size:9px">H:${c.hall}</span>${showSec ? `<br><b>${c.section}</b>` : ''}</td>`;
                }
            });
            h += "</tr>";
        });
        return h + "</tbody></table>";
    }

    function renderAll() {
        allTimetables.innerHTML = "";
        for(let k in timetables) {
            const isLocked = isSectionFinalized(k);
            let div = document.createElement("div"); div.className = "card";
            
            let lockHtml = isLocked ? `<div class="finalize-msg" style="font-size:12px; margin-bottom:10px">Timetable Finalized. No more entries allowed.</div>` : "";
            
            div.innerHTML = `<h4>Section ${k}</h4>` + lockHtml + render(timetables[k].slots, timetables[k].grid);
            let btnContainer = document.createElement("div"); btnContainer.style = "display:flex; gap:10px; margin-top:10px;";
            
            let finBtn = document.createElement("button");
            finBtn.style.background = isLocked ? "#94a3b8" : "#4b2c85";
            finBtn.innerText = isLocked ? "üîì Unfinalize Class" : "üîí Finalize Class";
            finBtn.onclick = () => toggleFinalize(k);
            btnContainer.appendChild(finBtn);

            let delBtn = document.createElement("button"); 
            delBtn.className = "clear"; 
            delBtn.innerText = "üóëÔ∏è Delete";
            delBtn.onclick = () => clearTT(k);
            
            let fixBtn = document.createElement("button"); 
            fixBtn.className = "fix"; 
            fixBtn.style.background = "var(--success)"; 
            fixBtn.innerText = "üîß Quick Fix";
            fixBtn.onclick = () => { 
                if(!checkAdminAuth()) return;
                let parts = k.split("-"); 
                dept.value = parts[0]; year.value = parts[1]; section.value = parts[2]; 
                checkLockState(); 
            };

            btnContainer.appendChild(fixBtn); 
            btnContainer.appendChild(delBtn);
            div.appendChild(btnContainer); 
            allTimetables.appendChild(div);
        }
    }

    function uiSetFixed() {
        if(!checkAdminAuth()) return;
        let key = `${dept.value}-${year.value}-${section.value}`;
        if(isSectionFinalized(key)) return alert("Class Finalized. Modification locked.");

        let sid = fixStaffId.value.trim(), d = +fixDay.value, pNum = +fixPeriod.value;
        let pIdx = -1, count = 0, slots = getSlots();
        for(let i=0; i<slots.length; i++) { if(slots[i].startsWith("P")) { count++; if(count === pNum) { pIdx = i; break; } } }
        let f = faculty.find(fac => fac.staffId === sid && fac.section === section.value);
        if(!f) return alert("Add staff first.");
        
        if(!fixedPeriods[key]) fixedPeriods[key] = {};
        fixedPeriods[key][`${d}-${pIdx}`] = { ...f, fixed: true };
        localStorage.setItem("fixedPeriods", JSON.stringify(fixedPeriods));
        renderAll();
    }

    function uiClearFixed() { 
        if(!isStrictAdmin()) return;
        let key = `${dept.value}-${year.value}-${section.value}`;
        if(isSectionFinalized(key)) return alert("Class Finalized. Modification locked.");
        
        delete fixedPeriods[key]; 
        localStorage.setItem("fixedPeriods", JSON.stringify(fixedPeriods)); 
        renderAll(); 
    }

    function clearTT(k){ 
        if(!isStrictAdmin()) return;
        if(confirm("Delete only class " + k + "?")){ 
            delete timetables[k]; 
            localStorage.setItem("timetables", JSON.stringify(timetables)); 
            renderAll(); checkLockState(); 
        } 
    }

    function clearAll(){ 
        if(!isStrictAdmin()) return;
        if(confirm("Wipe all data?")) { localStorage.clear(); location.reload(); } 
    }

    function studentView() {
        let k = `${stDept.value}-${stYear.value}-${stSection.value}`;
        if(!timetables[k]) {
            return alert("No data generated yet.");
        } else {
            document.getElementById('output').innerHTML = render(timetables[k].slots, timetables[k].grid);
            document.getElementById('pdf-meta').innerText = `Class: ${k}`;
            document.getElementById('pdf-btn-container').classList.remove('hidden');
        }
    }

    function staffView() {
        let sid = sId.value.trim(), combinedGrid = [], slots = null, total = 0;
        for(let k in timetables){
            if(!slots) slots = timetables[k].slots;
            if(!combinedGrid.length) combinedGrid = Array.from({length:5},()=>Array(slots.length).fill(null));
            timetables[k].grid.forEach((r,d) => r.forEach((c,p) => { 
                if(c && c.staffId === sid) { 
                    combinedGrid[d][p] = {...c, section: k}; 
                    total++; 
                } 
            }));
        }
        if(!total) return alert("No active schedule found.");
        document.getElementById('output').innerHTML = render(slots, combinedGrid, sid, true);
        document.getElementById('pdf-meta').innerText = `Staff ID: ${sid}`;
        document.getElementById('pdf-btn-container').classList.remove('hidden');
    }

    // THE FIX: PDF EXPORT FUNCTION
    function exportToPDF() {
        const area = document.getElementById('export-area');
        const content = document.getElementById('export-content');
        const header = document.getElementById('pdf-header');
        
        // 1. Clear old export content
        content.innerHTML = "";
        
        // 2. Decide content based on view
        if (currentUserRole === 'admin' && !document.getElementById('admin').classList.contains('hidden')) {
            // ADMIN VIEW: Export all timetables from #allTimetables
            const clones = document.getElementById('allTimetables').cloneNode(true);
            clones.querySelectorAll('button').forEach(btn => btn.remove()); // Remove UI buttons
            content.appendChild(clones);
        } else {
            // STAFF/STUDENT VIEW: Export content from #output
            const tableClone = document.getElementById('output').cloneNode(true);
            content.appendChild(tableClone);
        }

        // 3. Show export-only elements and move area into focus
        header.style.display = 'block';
        area.style.position = 'relative';
        area.style.left = '0';

        const opt = {
            margin: 0.5,
            filename: 'VCEW_Timetable.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        };

        // 4. Generate & Save
        html2pdf().set(opt).from(area).save().then(() => {
            // 5. Cleanup: Hide header and move area back off-screen
            header.style.display = 'none';
            content.innerHTML = "";
            area.style.position = 'absolute';
            area.style.left = '-9999px';
        });
    }

    function shareViaWhatsApp() { window.open(`https://wa.me/?text=Timetable%20Update:%20${window.location.href}`, '_blank'); }
    function updateHealth() { let k = `${dept.value}-${year.value}-${section.value}`; let facs = faculty.filter(f => f.dept === dept.value && f.year == year.value && f.section === section.value); document.getElementById('healthReport').innerHTML = `<b>${k}</b>: ${facs.length} Staff added.`; }

    document.getElementById('dept').addEventListener('change', checkLockState);
    document.getElementById('year').addEventListener('change', checkLockState);
    document.getElementById('section').addEventListener('change', checkLockState);
    renderAll();
</script>
</body>
</html>
